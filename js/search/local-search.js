class LocalSearch{constructor({path:e="",unescape:t=!1,top_n_per_article:a=1}){this.path=e,this.unescape=t,this.top_n_per_article=a,this.isfetched=!1,this.datas=null}getIndexByWord(e,n,s=!1){let l=[],r=new Set;return s||(n=n.toLowerCase()),e.forEach(t=>{this.unescape&&((e=document.createElement("div")).innerText=t,t=e.innerHTML);var e,a=t.length;if(0!==a){let e=0;var i;for(s||(t=t.toLowerCase());-1<(i=n.indexOf(t,e));)l.push({position:i,word:t}),r.add(t),e=i+a}}),l.sort((e,t)=>e.position!==t.position?e.position-t.position:t.word.length-e.word.length),[l,r]}mergeIntoSlice(e,t,a){var i;let{position:n,word:s}=a[0];for(var l=[],r=new Set;n+s.length<=t&&0!==a.length;){r.add(s),l.push({position:n,length:s.length});var o=n+s.length;for(a.shift();0!==a.length&&(i=a[0],n=i.position,s=i.word,o>n);)a.shift()}return{hits:l,start:e,end:t,count:r.size}}highlightKeyword(e,t){let a="",i=t.start;for(var{position:n,length:s}of t.hits)a+=e.substring(i,n),i=n+s,a+=`<mark class="search-keyword">${e.substr(n,s)}</mark>`;return a+=e.substring(i,t.end)}getResultItems(g){let p=[];return this.datas.forEach(({title:a,content:i,url:n})=>{var[s,l]=this.getIndexByWord(g,a),[r,o]=this.getIndexByWord(g,i),l=new Set([...l,...o]).size,o=s.length+r.length;if(0!==o){var c=[];0!==s.length&&c.push(this.mergeIntoSlice(0,a.length,s));let e=[];for(;0!==r.length;){var h=r[0].position,d=Math.max(0,h-20),h=Math.min(i.length,h+100);e.push(this.mergeIntoSlice(d,h,r))}e.sort((e,t)=>e.count!==t.count?t.count-e.count:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);s=parseInt(this.top_n_per_article,10);0<=s&&(e=e.slice(0,s));let t="";(n=new URL(n,location.origin)).searchParams.append("highlight",g.join(" ")),t+=0!==c.length?`<li class="local-search-hit-item"><a href="${n.href}"><span class="search-result-title">${this.highlightKeyword(a,c[0])}</span>`:`<li class="local-search-hit-item"><a href="${n.href}"><span class="search-result-title">${a}</span>`,e.forEach(e=>{t+=`<p class="search-result">${this.highlightKeyword(i,e)}...</p>`}),t+="</a></li>",p.push({item:t,id:p.length,hitCount:o,includedCount:l})}}),p}fetchData(){let t=!this.path.endsWith("json");fetch(this.path).then(e=>e.text()).then(e=>{this.isfetched=!0,this.datas=t?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(e),this.datas=this.datas.filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e)),window.dispatchEvent(new Event("search:loaded"))})}highlightText(t,e,a){var i=t.nodeValue;let n=e.start;var s,l,r=[];for({position:s,length:l}of e.hits){var o=document.createTextNode(i.substring(n,s)),c=(n=s+l,document.createElement("mark"));c.className=a,c.appendChild(document.createTextNode(i.substr(s,l))),r.push(o,c)}t.nodeValue=i.substring(n,e.end),r.forEach(e=>{t.parentNode.insertBefore(e,t)})}highlightSearchWords(e){var t=new URL(location.href).searchParams.get("highlight");let a=t?t.split(" "):[];if(a.length&&e){for(var i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),n=[];i.nextNode();)i.currentNode.parentNode.matches("button, select, textarea, .mermaid")||n.push(i.currentNode);n.forEach(e=>{var[t]=this.getIndexByWord(a,e.nodeValue);t.length&&(t=this.mergeIntoSlice(0,e.nodeValue.length,t),this.highlightText(e,t,"search-keyword"))})}}}window.addEventListener("load",()=>{let{path:e,top_n_per_article:t,unescape:a,languages:n,pagination:i}=GLOBAL_CONFIG.localSearch,s=i&&i.enable,l=new LocalSearch({path:e,top_n_per_article:t,unescape:a}),r=document.querySelector(".local-search-input input"),o=document.getElementById("local-search-stats"),c=document.getElementById("loading-status"),h=!e.endsWith("json"),d=0,g=i.hitsPerPage||10,p=[],u=(s||(d=void 0,p=void 0),{get pagination(){return document.getElementById("local-search-pagination")},get paginationList(){return document.querySelector("#local-search-pagination .ais-Pagination-list")}}),m=e=>{s?u.pagination.style.display=e?"":"none":u.pagination.style.display="none"},f=(e,t)=>{var a=document.getElementById("local-search-results"),i=s?p.slice(d*g,(d+1)*g):t;s&&0===i.length&&0<p.length?(d=0,f(e,t)):(i=i.map((e,t)=>{t=s?d*g+t+1:t+1;return e.item.replace('<li class="local-search-hit-item">',`<li class="local-search-hit-item" value="${t}">`)}),a.innerHTML=`<ol class="search-result-list">${i.join("")}</ol>`,i=(s?p:t).length,i=n.hits_stats.replace(/\$\{hits}/,i),o.innerHTML=`<hr><div class="search-result-stats">${i}</div>`,s&&(i=Math.ceil(p.length/g),v(d,i,e)),i=0<t.length,m(i),window.pjax&&window.pjax.refresh(a))},v=(i,e,t)=>{if(e<=1)u.pagination.style.display="none",u.paginationList.innerHTML="";else{u.pagination.style.display="block";var n=0===i,s=i===e-1,l=window.innerWidth<768?3:5;let t=Math.max(0,i-Math.floor(l/2));var r=Math.min(e-1,t+l-1);r-t+1<l&&(t=Math.max(0,r-l+1));let a="";l<e&&0<t&&(a+=`
        <li class="ais-Pagination-item ais-Pagination-item--page">
          <a class="ais-Pagination-link" aria-label="Page 1" href="#" data-page="0">1</a>
        </li>`,1<t)&&(a+=`
          <li class="ais-Pagination-item ais-Pagination-item--ellipsis">
            <span class="ais-Pagination-link">...</span>
          </li>`);for(let e=t;e<=r;e++){var o=e===i;a+=o?`
          <li class="ais-Pagination-item ais-Pagination-item--page ais-Pagination-item--selected">
            <span class="ais-Pagination-link" aria-label="Page ${e+1}">${e+1}</span>
          </li>`:`
          <li class="ais-Pagination-item ais-Pagination-item--page">
            <a class="ais-Pagination-link" aria-label="Page ${e+1}" href="#" data-page="${e}">${e+1}</a>
          </li>`}l<e&&r<e-1&&(r<e-2&&(a+=`
          <li class="ais-Pagination-item ais-Pagination-item--ellipsis">
            <span class="ais-Pagination-link">...</span>
          </li>`),a+=`
        <li class="ais-Pagination-item ais-Pagination-item--page">
          <a class="ais-Pagination-link" aria-label="Page ${e}" href="#" data-page="${e-1}">${e}</a>
        </li>`),1<e?u.paginationList.innerHTML=`
            <li class="ais-Pagination-item ais-Pagination-item--previousPage ${n?"ais-Pagination-item--disabled":""}">
              ${n?'<span class="ais-Pagination-link ais-Pagination-link--disabled" aria-label="Previous Page"><i class="fas fa-angle-left"></i></span>':`<a class="ais-Pagination-link" aria-label="Previous Page" href="#" data-page="${i-1}"><i class="fas fa-angle-left"></i></a>`}
            </li>
            ${a}
            <li class="ais-Pagination-item ais-Pagination-item--nextPage ${s?"ais-Pagination-item--disabled":""}">
              ${s?'<span class="ais-Pagination-link ais-Pagination-link--disabled" aria-label="Next Page"><i class="fas fa-angle-right"></i></span>':`<a class="ais-Pagination-link" aria-label="Next Page" href="#" data-page="${i+1}"><i class="fas fa-angle-right"></i></a>`}
            </li>`:u.pagination.style.display="none"}},P=()=>{document.getElementById("local-search-results").textContent="",o.textContent="",m(!1),s&&(p=[],d=0)},w=e=>{document.getElementById("local-search-results").textContent="";var t=document.createElement("div");t.className="search-result-stats",t.textContent=n.hits_empty.replace(/\$\{query}/,e),o.innerHTML=t.outerHTML,m(!1),s&&(p=[],d=0)},y=()=>{if(l.isfetched){let e=r.value.trim().toLowerCase();""!==(e=h?e.replace(/</g,"&lt;").replace(/>/g,"&gt;"):e)&&(c.hidden=!1);var a=e.split(/[-\s]+/);let t=[];0<e.length&&(t=l.getResultItems(a)),1===a.length&&""===a[0]?P():0===t.length?w(e):(t.sort((e,t)=>e.includedCount!==t.includedCount?t.includedCount-e.includedCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id),s&&(p=t,d=0),f(e,t)),c.hidden=!0}},b=!1,E=document.getElementById("search-mask"),x=document.querySelector("#local-search .search-dialog"),L=()=>{window.innerWidth<768&&x.style.setProperty("--search-height",window.innerHeight+"px")},S=()=>{btf.overflowPaddingR.add(),btf.animateIn(E,"to_show 0.5s"),btf.animateIn(x,"titleScale 0.5s"),setTimeout(()=>{r.focus()},300),b||(l.isfetched||l.fetchData(),r.addEventListener("input",y),b=!0),document.addEventListener("keydown",function e(t){"Escape"===t.code&&(I(),document.removeEventListener("keydown",e))}),L(),window.addEventListener("resize",L)},I=()=>{btf.overflowPaddingR.remove(),btf.animateOut(x,"search_close .5s"),btf.animateOut(E,"to_hide 0.5s"),window.removeEventListener("resize",L)},k=()=>{btf.addEventListenerPjax(document.querySelector("#search-button > .search"),"click",S)};window.addEventListener("search:loaded",()=>{var e=document.getElementById("loading-database");e.nextElementSibling.style.visibility="visible",e.remove()}),k(),document.querySelector("#local-search .search-close-button").addEventListener("click",I),E.addEventListener("click",I),GLOBAL_CONFIG.localSearch.preload&&l.fetchData(),l.highlightSearchWords(document.getElementById("article-container")),s&&u.pagination.addEventListener("click",e=>{e.preventDefault();var e=e.target.closest("a[data-page]");e&&(e=parseInt(e.dataset.page,10),!isNaN(e))&&0<p.length&&(d=e,f(r.value.trim().toLowerCase(),p))}),m(!1),window.addEventListener("pjax:complete",()=>{btf.isHidden(E)||I(),l.highlightSearchWords(document.getElementById("article-container")),k()})});